{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Gestion des Commandes</h2>

    <div class="row mb-4">
        <div class="col">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" data-filter="all">Toutes</button>
                <button type="button" class="btn btn-outline-warning" data-filter="EN_ATTENTE">En attente</button>
                <button type="button" class="btn btn-outline-info" data-filter="EN_PREPARATION">En préparation</button>
                <button type="button" class="btn btn-outline-primary" data-filter="PRETE">Prêtes</button>
                <button type="button" class="btn btn-outline-success" data-filter="RECUPEREE">Récupérées</button>
                <button type="button" class="btn btn-outline-danger" data-filter="ANNULEE">Annulées</button>
            </div>
        </div>
    </div>

    {% if commandes %}
        <div class="row">
            {% for commande in commandes %}
                <div class="col-md-6 mb-4 commande-item" data-statut="{{ commande.statut }}">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Commande #{{ commande.id }}</h5>
                            <span class="badge {% if commande.statut == 'EN_ATTENTE' %}bg-warning
                                            {% elif commande.statut == 'EN_PREPARATION' %}bg-info
                                            {% elif commande.statut == 'PRETE' %}bg-primary
                                            {% elif commande.statut == 'RECUPEREE' %}bg-success
                                            {% else %}bg-danger{% endif %}">
                                {{ commande.get_statut_display }}
                            </span>
                        </div>
                        <div class="card-body">
                            <p><strong>Client:</strong> {{ commande.client.username }}</p>
                            <p><strong>Date:</strong> {{ commande.date_commande|date:"d/m/Y H:i" }}</p>
                            <p><strong>Total:</strong> {{ commande.total }} FCFA</p>
                            <p><strong>Adresse de livraison:</strong> {{ commande.adresse_livraison }}</p>
                            <p><strong>Téléphone:</strong> {{ commande.telephone }}</p>
                            
                            {% if commande.notes %}
                                <p><strong>Notes:</strong> {{ commande.notes }}</p>
                            {% endif %}

                            <div class="mt-3">
                                <h6>Articles commandés:</h6>
                                <ul class="list-group list-group-flush">
                                    {% for ligne in commande.lignes.all %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ ligne.menu.nom }}
                                            <span class="badge bg-primary rounded-pill">
                                                {{ ligne.quantite }} x {{ ligne.prix_unitaire }} FCFA
                                            </span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <div class="mt-3">
                                <div class="btn-group" role="group">
                                    {% if commande.statut == 'EN_ATTENTE' %}
                                        <button type="button" class="btn btn-info" onclick="updateStatus('{{ commande.id }}', 'EN_PREPARATION')">
                                            <i class="fa fa-utensils"></i> En préparation
                                        </button>
                                    {% endif %}
                                    {% if commande.statut == 'EN_PREPARATION' %}
                                        <button type="button" class="btn btn-primary" onclick="updateStatus('{{ commande.id }}', 'PRETE')">
                                            <i class="fa fa-check"></i> Prête
                                        </button>
                                    {% endif %}
                                    {% if commande.statut == 'PRETE' %}
                                        <button type="button" class="btn btn-success" onclick="updateStatus('{{ commande.id }}', 'RECUPEREE')">
                                            <i class="fa fa-check"></i> Récupérée
                                        </button>
                                    {% endif %}
                                    {% if commande.statut == 'EN_ATTENTE' %}
                                        <button type="button" class="btn btn-danger" onclick="updateStatus('{{ commande.id }}', 'ANNULEE')">
                                            <i class="fa fa-times"></i> Annulée
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            Aucune commande pour le moment.
        </div>
    {% endif %}
</div>

{% block extra_js %}
<script>
function updateStatus(commandeId, newStatus) {
    if (confirm('Êtes-vous sûr de vouloir modifier le statut de cette commande ?')) {
        fetch(`/commandes/commande/${commandeId}/modifier-statut/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                statut: newStatus
            })
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                response.json().then(data => {
                    alert(data.error || 'Une erreur est survenue lors de la mise à jour du statut.');
                }).catch(() => {
                    alert('Une erreur est survenue lors de la mise à jour du statut.');
                });
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Filtrage des commandes
document.querySelectorAll('[data-filter]').forEach(button => {
    button.addEventListener('click', function() {
        const filter = this.dataset.filter;
        
        // Mise à jour des boutons
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.classList.remove('active');
        });
        this.classList.add('active');
        
        // Filtrage des commandes
        document.querySelectorAll('.commande-item').forEach(item => {
            if (filter === 'all' || item.dataset.statut === filter) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}